# docker-compose.app.yml
# Needled Web Application - Production
#
# Prerequisites:
#   1. Infrastructure running: docker-compose -f docker-compose.infrastructure.yml up -d
#   2. nginx-proxy network exists on the server
#
# Usage:
#   Initial install: docker-compose -f docker-compose.app.yml up -d --build
#   Updates: docker-compose -f docker-compose.app.yml up -d --build --force-recreate
#   Migrations: docker-compose -f docker-compose.app.yml exec app npx prisma migrate deploy

services:
  app:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL:-https://needled.app}
    container_name: needled-app
    hostname: needled-app
    environment:
      - NODE_ENV=production
      - PORT=3000
      - HOSTNAME=0.0.0.0
      - DATABASE_URL=postgresql://needled:${DB_PASSWORD}@needled-db:5432/needled
      # Email notifications (SendGrid)
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - SENDGRID_FROM_EMAIL=${SENDGRID_FROM_EMAIL:-hello@needled.app}
      # Application URLs
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL:-https://needled.app}
      # Security secrets
      - UNSUBSCRIBE_SECRET=${UNSUBSCRIBE_SECRET}
      - CRON_SECRET=${CRON_SECRET}
      # Disable Next.js telemetry
      - NEXT_TELEMETRY_DISABLED=1
      # Nginx-proxy environment variables
      - VIRTUAL_HOST=${PROD_DOMAIN:-needled.app}
      - LETSENCRYPT_HOST=${LETSENCRYPT_DOMAIN:-needled.app}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-admin@needled.app}
      - HTTPS_METHOD=redirect
      - VIRTUAL_PORT=3000
    networks:
      - needled-network
      - nginx-proxy
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://127.0.0.1:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  needled-network:
    external: true
  nginx-proxy:
    external: true
