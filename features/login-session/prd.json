{
  "feature": "Login & Session Management",
  "stories": [
    {
      "id": "LOGIN-001",
      "title": "Add Session model to Prisma schema",
      "description": "Create Session model for server-side session management",
      "acceptance_criteria": [
        "Session model exists in prisma/schema.prisma with fields: id, token (unique), userId, expiresAt, createdAt",
        "Session has relation to User model",
        "Migration runs successfully with: npx prisma migrate dev --name add-session-model",
        "Prisma client is regenerated"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-002",
      "title": "Add passwordHash field to User model",
      "description": "Update User model to store hashed passwords",
      "acceptance_criteria": [
        "User model in prisma/schema.prisma has passwordHash field (String, optional for migration)",
        "Migration runs successfully with: npx prisma migrate dev --name add-user-password",
        "Prisma client is regenerated"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-003",
      "title": "Create auth utility functions",
      "description": "Create authentication helper functions for password hashing and session management",
      "acceptance_criteria": [
        "File src/lib/auth.ts exists",
        "hashPassword(password: string) function uses bcrypt with cost factor 12",
        "verifyPassword(password: string, hash: string) function compares password to hash",
        "generateSessionToken() function returns 32-byte hex string",
        "bcrypt package is installed (npm install bcrypt @types/bcrypt)",
        "Unit tests pass in tests/unit/auth.test.ts"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-004",
      "title": "Create session management utilities",
      "description": "Add functions to create, validate, and delete sessions",
      "acceptance_criteria": [
        "createSession(userId: string) function in src/lib/auth.ts creates session in DB, returns token",
        "validateSession(token: string) function returns user if valid session, null if invalid/expired",
        "deleteSession(token: string) function removes session from DB",
        "Sessions expire 30 days from creation",
        "Unit tests pass in tests/unit/auth.test.ts"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-005",
      "title": "Create cookie utilities",
      "description": "Add utilities for setting and clearing session cookies",
      "acceptance_criteria": [
        "File src/lib/cookies.ts exists",
        "setSessionCookie(token: string) function sets HTTP-only cookie named 'needled_session'",
        "clearSessionCookie() function clears the session cookie",
        "Cookie has SameSite=Lax, Secure in production, maxAge of 30 days",
        "getSessionToken() function extracts token from request cookies"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-006",
      "title": "Create login API endpoint",
      "description": "API endpoint for user authentication",
      "acceptance_criteria": [
        "POST /api/auth/login endpoint exists in src/app/api/auth/login/route.ts",
        "Accepts { email, password } in request body",
        "Validates email and password with Zod schema",
        "Returns 401 with { error: 'Invalid credentials' } for wrong email/password",
        "Returns 200 with user data (excluding passwordHash) on success",
        "Sets session cookie on successful login",
        "Unit tests pass"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-007",
      "title": "Create logout API endpoint",
      "description": "API endpoint to end user session",
      "acceptance_criteria": [
        "POST /api/auth/logout endpoint exists in src/app/api/auth/logout/route.ts",
        "Deletes session from database",
        "Clears session cookie",
        "Returns 200 with { success: true }",
        "Works even if no session exists (idempotent)"
      ],
      "passes": true
    },
    {
      "id": "LOGIN-008",
      "title": "Create session check API endpoint",
      "description": "API endpoint to verify current authentication status",
      "acceptance_criteria": [
        "GET /api/auth/session endpoint exists in src/app/api/auth/session/route.ts",
        "Returns user data (excluding passwordHash) if valid session",
        "Returns 401 with { error: 'Not authenticated' } if no valid session",
        "Used by client to check auth state"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-009",
      "title": "Update user creation API to require email and password",
      "description": "Modify POST /api/users to handle authentication fields",
      "acceptance_criteria": [
        "POST /api/users requires email field (string, valid email format)",
        "POST /api/users requires password field (string, min 8 characters)",
        "Password is hashed before storing",
        "Session is created after user creation",
        "Session cookie is set in response",
        "Returns user data without passwordHash",
        "Returns 409 if email already exists"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-010",
      "title": "Create email and password validation schema",
      "description": "Add Zod schema for auth-related validations",
      "acceptance_criteria": [
        "File src/lib/validations/auth.ts exists",
        "loginSchema validates { email: string (email format), password: string (min 1) }",
        "registerSchema validates { email: string (email format), password: string (min 8) }",
        "Schemas are exported and used in relevant API routes"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-011",
      "title": "Create Login page UI",
      "description": "Build the login page with email/password form",
      "acceptance_criteria": [
        "Page exists at src/app/login/page.tsx",
        "Form has email input with label and validation",
        "Form has password input with label and type='password'",
        "Submit button says 'Log in' with loading state",
        "Link to /onboarding for new users: 'New here? Create an account'",
        "Error message displays for invalid credentials",
        "Follows DESIGN_SYSTEM.md patterns (Card wrapper, proper spacing)",
        "Page is responsive (centered card on desktop)"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-012",
      "title": "Implement login form submission",
      "description": "Wire up login form to API endpoint",
      "acceptance_criteria": [
        "Form submits to POST /api/auth/login",
        "Shows loading spinner on button during submission",
        "Displays toast notification on successful login",
        "Redirects to /dashboard on success",
        "Displays inline error message on failure",
        "Disables submit button while loading"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-013",
      "title": "Update onboarding to collect email and password",
      "description": "Add authentication fields to user onboarding flow",
      "acceptance_criteria": [
        "Onboarding form includes email field (required, email format)",
        "Onboarding form includes password field (required, min 8 chars)",
        "Onboarding form includes password confirmation field",
        "Validation shows error if passwords don't match",
        "Email field has clear label and placeholder",
        "Password requirements shown as helper text"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-014",
      "title": "Update onboarding form schema and submission",
      "description": "Update validation schema and API call for onboarding",
      "acceptance_criteria": [
        "User schema in src/lib/validations/user.ts includes email and password",
        "Password confirmation validation works client-side",
        "Form submits email and password to POST /api/users",
        "User is automatically logged in after onboarding",
        "Redirects to /dashboard on success"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-015",
      "title": "Create authentication middleware",
      "description": "Protect routes requiring authentication",
      "acceptance_criteria": [
        "Middleware file exists at src/middleware.ts",
        "Protected routes (/dashboard, /weigh-in, /injection, /habits, /calendar, /settings) require valid session",
        "Unauthenticated requests to protected routes redirect to /login",
        "Public routes (/, /login, /onboarding) work without session",
        "/api/auth/* routes are not protected by middleware"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-016",
      "title": "Add home page redirect for authenticated users",
      "description": "Redirect logged-in users from home page to dashboard",
      "acceptance_criteria": [
        "Authenticated users visiting / are redirected to /dashboard",
        "Unauthenticated users see normal home page",
        "Redirect happens server-side (no flash of home page)",
        "Middleware handles this redirect"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-017",
      "title": "Add logout button to header navigation",
      "description": "Allow users to log out from the app header",
      "acceptance_criteria": [
        "Logout button/link visible in header navigation",
        "Clicking logout calls POST /api/auth/logout",
        "Shows toast notification on successful logout",
        "Redirects to home page (/) after logout",
        "Button is styled consistently with header design"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-018",
      "title": "Create useAuth hook for client-side auth state",
      "description": "React hook to manage authentication state",
      "acceptance_criteria": [
        "Hook exists at src/hooks/useAuth.ts",
        "Returns { user, isLoading, isAuthenticated, logout }",
        "Fetches session status from GET /api/auth/session",
        "logout() function calls API and redirects",
        "Used in header component for logout functionality"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-019",
      "title": "Handle existing users without passwords",
      "description": "Migration path for users created before auth was added",
      "acceptance_criteria": [
        "Login fails gracefully for users with null passwordHash",
        "Error message suggests re-registering if account has no password",
        "No server errors when checking users without passwords"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-020",
      "title": "Add login page redirect for authenticated users",
      "description": "Redirect already logged-in users away from login page",
      "acceptance_criteria": [
        "Authenticated users visiting /login are redirected to /dashboard",
        "Middleware handles this redirect",
        "No flash of login page for authenticated users"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-021",
      "title": "E2E test: New user registration and auto-login",
      "description": "Test complete onboarding flow with authentication",
      "acceptance_criteria": [
        "Test file exists at tests/e2e/login-session.spec.ts",
        "Test completes onboarding with email and password",
        "Verifies user is redirected to dashboard after onboarding",
        "Verifies user remains logged in on page refresh",
        "Test passes with npx playwright test login-session"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-022",
      "title": "E2E test: Login and logout flow",
      "description": "Test login and logout for existing users",
      "acceptance_criteria": [
        "Test creates a user via API with email/password",
        "Test navigates to /login and submits credentials",
        "Verifies redirect to dashboard",
        "Test clicks logout button",
        "Verifies redirect to home page",
        "Verifies protected route redirects to login after logout",
        "Test passes with npx playwright test login-session"
      ],
      "passes": false
    },
    {
      "id": "LOGIN-023",
      "title": "E2E test: Protected route access",
      "description": "Test that unauthenticated users cannot access protected routes",
      "acceptance_criteria": [
        "Test attempts to visit /dashboard without session",
        "Verifies redirect to /login",
        "Test attempts to visit /calendar without session",
        "Verifies redirect to /login",
        "Test passes with npx playwright test login-session"
      ],
      "passes": false
    }
  ]
}
